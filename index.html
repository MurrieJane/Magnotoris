<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel 9a EMF Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .canvas-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .readout-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Pulse animation for active recording */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
        .btn-active {
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen pb-32">

    <!-- Header -->
    <header class="w-full max-w-md mb-6 text-center">
        <h1 class="text-2xl font-bold text-cyan-400">EMF Detector</h1>
        <p class="text-xs text-slate-400">Using Pixel 9a Magnetometer Sensor</p>
    </header>

    <!-- Main Readouts -->
    <div class="w-full max-w-md grid grid-cols-2 gap-4 mb-6">
        
        <!-- Magnetic Field Readout -->
        <div class="readout-card rounded-xl p-4 flex flex-col items-center justify-center">
            <span class="text-slate-400 text-xs uppercase tracking-wider mb-1">Magnetic Field (Bz)</span>
            <div class="flex items-baseline">
                <span id="val-b-field" class="text-3xl font-mono font-bold text-blue-400">0.0</span>
                <span class="ml-1 text-sm text-blue-300">µT</span>
            </div>
            <span class="text-xs text-slate-500 mt-2">Raw Sensor Data</span>
        </div>

        <!-- EMF Readout -->
        <div class="readout-card rounded-xl p-4 flex flex-col items-center justify-center border-red-900/30 bg-red-900/10">
            <span class="text-slate-400 text-xs uppercase tracking-wider mb-1">Induced EMF</span>
            <div class="flex items-baseline">
                <span id="val-emf" class="text-3xl font-mono font-bold text-red-400">0.00</span>
                <span class="ml-1 text-sm text-red-300">mV</span>
            </div>
            <span class="text-xs text-slate-500 mt-2">Calculated (dB/dt)</span>
        </div>
    </div>

    <!-- Chart -->
    <div class="w-full max-w-md readout-card rounded-xl p-2 mb-6">
        <div class="canvas-container">
            <canvas id="emfChart"></canvas>
        </div>
    </div>

    <!-- Controls / Virtual Coil Settings -->
    <div class="w-full max-w-md readout-card rounded-xl p-4 mb-6">
        <h2 class="text-sm font-bold text-slate-300 mb-4 border-b border-slate-700 pb-2">Virtual Coil Settings</h2>
        
        <div class="mb-4">
            <label class="flex justify-between text-xs text-slate-400 mb-2">
                <span>Number of Turns (N)</span>
                <span id="lbl-turns" class="text-cyan-300">500</span>
            </label>
            <input type="range" id="slider-turns" min="10" max="2000" step="10" value="500" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
        </div>

        <div class="mb-2">
            <label class="flex justify-between text-xs text-slate-400 mb-2">
                <span>Coil Radius (cm)</span>
                <span id="lbl-radius" class="text-cyan-300">5.0</span>
            </label>
            <input type="range" id="slider-radius" min="1" max="50" step="0.5" value="5.0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
        </div>
        
        <p class="text-[10px] text-slate-500 mt-4 italic">
            *EMF is calculated based on these virtual dimensions. The phone measures the field; this math simulates what voltage a coil of this size would produce.
        </p>
    </div>

    <!-- Error/Help Panel (Hidden by default) -->
    <div id="error-panel" class="hidden w-full max-w-md bg-red-900/20 border border-red-500/50 rounded-xl p-4 mb-20 text-sm text-slate-300">
        <h3 class="font-bold text-red-400 flex items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            Sensor Access Blocked
        </h3>
        <p class="mb-2">The browser did not prompt for access. This is common on Android Chrome.</p>
        <p class="font-bold text-slate-100 mb-1">How to fix:</p>
        <ol class="list-decimal ml-4 space-y-1 text-xs">
            <li>Type <code class="bg-slate-800 px-1 rounded">chrome://flags</code> in the URL bar.</li>
            <li>Search for <b>"Generic Sensor"</b>.</li>
            <li>Enable <b>"Generic Sensor Extra Classes"</b>.</li>
            <li>Relaunch Chrome.</li>
            <li>Alternatively, check <b>Settings > Site Settings > Motion Sensors</b> and ensure they are allowed.</li>
        </ol>
    </div>

    <!-- Start Button / Status -->
    <div class="fixed bottom-6 left-0 right-0 flex justify-center px-4">
        <button id="btn-start" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-full shadow-lg shadow-cyan-900/50 transition-all transform active:scale-95">
            Start Sensor
        </button>
    </div>
    <div id="status-msg" class="fixed bottom-1 text-xs text-slate-600 text-center w-full pb-1"></div>

    <script>
        // --- Configuration ---
        const MAX_DATA_POINTS = 50;
        let isRunning = false;
        let magnetometer = null;

        // Virtual Coil Parameters
        let coilTurns = 500;
        let coilRadiusCm = 5.0;
        let coilAreaM2 = Math.PI * Math.pow(coilRadiusCm / 100, 2);

        // Data Storage
        let lastB = 0;
        let lastTime = 0;
        
        // Smoothing (Low Pass Filter)
        const ALPHA = 0.2; // Smoothing factor (0.1 = heavy smoothing, 1.0 = no smoothing)
        let smoothedB = 0;

        // Chart Setup
        const ctx = document.getElementById('emfChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(MAX_DATA_POINTS).fill(''),
                datasets: [
                    {
                        label: 'B-Field (µT)',
                        data: Array(MAX_DATA_POINTS).fill(null),
                        borderColor: 'rgba(59, 130, 246, 0.5)', // Blue
                        borderWidth: 1,
                        yAxisID: 'y_B',
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: 'EMF (mV)',
                        data: Array(MAX_DATA_POINTS).fill(null),
                        borderColor: 'rgba(248, 113, 113, 1)', // Red
                        borderWidth: 2,
                        yAxisID: 'y_EMF',
                        pointRadius: 0,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'none' },
                scales: {
                    x: { display: false },
                    y_B: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { display: false },
                        title: { display: true, text: 'µT', color: '#3b82f6', font: {size: 10} },
                        ticks: { color: '#3b82f6', font: {size: 10} }
                    },
                    y_EMF: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        title: { display: true, text: 'mV', color: '#f87171', font: {size: 10} },
                        ticks: { color: '#f87171', font: {size: 10} }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#94a3b8', font: {size: 10} } }
                }
            }
        });

        // --- DOM Elements ---
        const btnStart = document.getElementById('btn-start');
        const elValB = document.getElementById('val-b-field');
        const elValEmf = document.getElementById('val-emf');
        const elStatus = document.getElementById('status-msg');
        const errorPanel = document.getElementById('error-panel');
        
        // Settings Inputs
        const sliderTurns = document.getElementById('slider-turns');
        const sliderRadius = document.getElementById('slider-radius');
        const lblTurns = document.getElementById('lbl-turns');
        const lblRadius = document.getElementById('lbl-radius');

        // --- Event Listeners ---
        sliderTurns.addEventListener('input', (e) => {
            coilTurns = parseInt(e.target.value);
            lblTurns.textContent = coilTurns;
        });

        sliderRadius.addEventListener('input', (e) => {
            coilRadiusCm = parseFloat(e.target.value);
            lblRadius.textContent = coilRadiusCm.toFixed(1);
            coilAreaM2 = Math.PI * Math.pow(coilRadiusCm / 100, 2);
        });

        btnStart.addEventListener('click', () => {
            if (!isRunning) {
                initSensor();
            } else {
                stopSensor();
            }
        });

        // --- Logic ---

        function stopSensor() {
            if (magnetometer) {
                magnetometer.stop();
            }
            isRunning = false;
            btnStart.textContent = "Start Sensor";
            btnStart.classList.replace('bg-red-600', 'bg-cyan-600');
            btnStart.classList.replace('hover:bg-red-500', 'hover:bg-cyan-500');
            btnStart.classList.remove('btn-active');
            elStatus.textContent = "Sensor stopped.";
        }

        async function initSensor() {
            errorPanel.classList.add('hidden'); // Hide error panel initially

            // 1. Check API Support
            if (!("Magnetometer" in window)) {
                showError("Magnetometer API not supported. Use Chrome on Android and enable 'Generic Sensor Extra Classes' in flags.");
                return;
            }

            // 2. Permission Check (Try/Catch because some browsers throw on unknown names)
            try {
                const result = await navigator.permissions.query({ name: "magnetometer" });
                if (result.state === "denied") {
                    showError("Permission denied. Enable 'Motion Sensors' in Site Settings.");
                    return;
                }
            } catch (error) {
                // If the permission query fails, we proceed and try to open the sensor anyway,
                // as the browser might prompt then.
                console.log("Permission query API not fully supported, proceeding to open sensor...");
            }

            try {
                // 3. Initialize Sensor
                magnetometer = new Magnetometer({ frequency: 60 });
                
                // 4. Attach Error Handler FIRST
                magnetometer.addEventListener("error", (event) => {
                    if (event.error.name === "NotReadableError") {
                        showError("Sensor not readable. This usually means hardware access is blocked by the OS or a Chrome Flag.");
                    } else if (event.error.name === "SecurityError") {
                         showError("Security Error. Permissions blocked or not using HTTPS.");
                    } else {
                        showError(`Error: ${event.error.name} - ${event.error.message}`);
                    }
                    stopSensor();
                });

                magnetometer.addEventListener("reading", () => {
                    processReading(magnetometer.x, magnetometer.y, magnetometer.z, magnetometer.timestamp);
                });

                // 5. Start
                magnetometer.start();
                isRunning = true;
                
                // Update Button UI
                btnStart.textContent = "Stop Sensor";
                btnStart.classList.replace('bg-cyan-600', 'bg-red-600');
                btnStart.classList.replace('hover:bg-cyan-500', 'hover:bg-red-500');
                btnStart.classList.add('btn-active');
                elStatus.textContent = "Sensor active. Wave magnet to induce EMF.";
                
                // Initialize timing
                lastTime = performance.now();

            } catch (error) {
                if (error.name === "ReferenceError") {
                    showError("Magnetometer feature not enabled. Enable 'Generic Sensor Extra Classes' in chrome://flags");
                } else {
                    showError("Failed to start: " + error.message);
                }
            }
        }

        function showError(msg) {
            elStatus.textContent = "Error detected.";
            errorPanel.classList.remove('hidden');
            // Add specific message to the panel text if needed, but the hardcoded text covers the 90% case
            console.error(msg);
        }

        function processReading(x, y, z, timestamp) {
            if (!timestamp) timestamp = performance.now();

            // We use the Z-axis (perpendicular to screen) for the "Loop" simulation
            let rawB = z; 

            // Initialize on first run
            if (lastB === 0) {
                lastB = rawB;
                smoothedB = rawB;
                lastTime = timestamp;
                return;
            }

            // 1. Low Pass Filter
            smoothedB = smoothedB + ALPHA * (rawB - smoothedB);

            // 2. Calculate dt
            let dt = (timestamp - lastTime) / 1000;
            
            // Avoid division by zero
            if (dt <= 0 || dt > 1.0) {
                lastTime = timestamp;
                return; 
            }

            // 3. Calculate dB
            let deltaB_Tesla = (smoothedB - lastB) * 1e-6; 

            // 4. Faraday's Law
            let emfVolts = -1 * coilTurns * coilAreaM2 * (deltaB_Tesla / dt);
            
            // Convert to mV
            let emfMillivolts = emfVolts * 1000;

            // 5. Update UI
            elValB.textContent = smoothedB.toFixed(1);
            elValEmf.textContent = emfMillivolts.toFixed(2);

            updateChart(smoothedB, emfMillivolts);

            // 6. Store State
            lastB = smoothedB;
            lastTime = timestamp;
        }

        function updateChart(bVal, emfVal) {
            const dataB = chart.data.datasets[0].data;
            const dataEmf = chart.data.datasets[1].data;

            dataB.shift();
            dataB.push(bVal);
            
            dataEmf.shift();
            dataEmf.push(emfVal);

            chart.update();
        }

        // Mock Data Logic (Demo Mode)
        // Only runs if Magnetometer is definitely NOT in window object
        if (!("Magnetometer" in window)) {
            setTimeout(() => {
                if(!isRunning) elStatus.innerHTML = "<span class='text-yellow-500'>Demo Mode (Sensor API Missing)</span>";
                setInterval(() => {
                    if(isRunning) return; 
                    let time = performance.now() / 1000;
                    let fakeB = 50 * Math.sin(time * 5); 
                    let fakedt = 0.016;
                    let fakeDiff = (fakeB - (50 * Math.sin((time - fakedt) * 5))) * 1e-6;
                    let fakeEmf = -1 * coilTurns * coilAreaM2 * (fakeDiff / fakedt) * 1000;
                    
                    elValB.textContent = fakeB.toFixed(1);
                    elValEmf.textContent = fakeEmf.toFixed(2);
                    updateChart(fakeB, fakeEmf);
                }, 1000 / 60);
            }, 1000);
        }
    </script>
</body>
</html>
