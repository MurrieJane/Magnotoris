<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel 9a EMF Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .canvas-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .readout-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <!-- Header -->
    <header class="w-full max-w-md mb-6 text-center">
        <h1 class="text-2xl font-bold text-cyan-400">EMF Detector</h1>
        <p class="text-xs text-slate-400">Using Pixel 9a Magnetometer Sensor</p>
    </header>

    <!-- Main Readouts -->
    <div class="w-full max-w-md grid grid-cols-2 gap-4 mb-6">
        
        <!-- Magnetic Field Readout -->
        <div class="readout-card rounded-xl p-4 flex flex-col items-center justify-center">
            <span class="text-slate-400 text-xs uppercase tracking-wider mb-1">Magnetic Field (Bz)</span>
            <div class="flex items-baseline">
                <span id="val-b-field" class="text-3xl font-mono font-bold text-blue-400">0.0</span>
                <span class="ml-1 text-sm text-blue-300">µT</span>
            </div>
            <span class="text-xs text-slate-500 mt-2">Raw Sensor Data</span>
        </div>

        <!-- EMF Readout -->
        <div class="readout-card rounded-xl p-4 flex flex-col items-center justify-center border-red-900/30 bg-red-900/10">
            <span class="text-slate-400 text-xs uppercase tracking-wider mb-1">Induced EMF</span>
            <div class="flex items-baseline">
                <span id="val-emf" class="text-3xl font-mono font-bold text-red-400">0.00</span>
                <span class="ml-1 text-sm text-red-300">mV</span>
            </div>
            <span class="text-xs text-slate-500 mt-2">Calculated (dB/dt)</span>
        </div>
    </div>

    <!-- Chart -->
    <div class="w-full max-w-md readout-card rounded-xl p-2 mb-6">
        <div class="canvas-container">
            <canvas id="emfChart"></canvas>
        </div>
    </div>

    <!-- Controls / Virtual Coil Settings -->
    <div class="w-full max-w-md readout-card rounded-xl p-4 mb-20">
        <h2 class="text-sm font-bold text-slate-300 mb-4 border-b border-slate-700 pb-2">Virtual Coil Settings</h2>
        
        <div class="mb-4">
            <label class="flex justify-between text-xs text-slate-400 mb-2">
                <span>Number of Turns (N)</span>
                <span id="lbl-turns" class="text-cyan-300">500</span>
            </label>
            <input type="range" id="slider-turns" min="10" max="2000" step="10" value="500" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
        </div>

        <div class="mb-2">
            <label class="flex justify-between text-xs text-slate-400 mb-2">
                <span>Coil Radius (cm)</span>
                <span id="lbl-radius" class="text-cyan-300">5.0</span>
            </label>
            <input type="range" id="slider-radius" min="1" max="50" step="0.5" value="5.0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
        </div>
        
        <p class="text-[10px] text-slate-500 mt-4 italic">
            *EMF is calculated based on these virtual dimensions. The phone measures the field; this math simulates what voltage a coil of this size would produce.
        </p>
    </div>

    <!-- Start Button / Status -->
    <div class="fixed bottom-6 left-0 right-0 flex justify-center px-4">
        <button id="btn-start" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-8 rounded-full shadow-lg shadow-cyan-900/50 transition-all transform active:scale-95">
            Start Sensor
        </button>
    </div>
    <div id="status-msg" class="fixed bottom-1 text-xs text-slate-600 text-center w-full pb-1"></div>

    <script>
        // --- Configuration ---
        const MAX_DATA_POINTS = 50;
        let isRunning = false;
        let magnetometer = null;

        // Virtual Coil Parameters
        let coilTurns = 500;
        let coilRadiusCm = 5.0;
        let coilAreaM2 = Math.PI * Math.pow(coilRadiusCm / 100, 2);

        // Data Storage
        let lastB = 0;
        let lastTime = 0;
        
        // Smoothing (Low Pass Filter)
        const ALPHA = 0.2; // Smoothing factor (0.1 = heavy smoothing, 1.0 = no smoothing)
        let smoothedB = 0;

        // Chart Setup
        const ctx = document.getElementById('emfChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(MAX_DATA_POINTS).fill(''),
                datasets: [
                    {
                        label: 'B-Field (µT)',
                        data: Array(MAX_DATA_POINTS).fill(null),
                        borderColor: 'rgba(59, 130, 246, 0.5)', // Blue
                        borderWidth: 1,
                        yAxisID: 'y_B',
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: 'EMF (mV)',
                        data: Array(MAX_DATA_POINTS).fill(null),
                        borderColor: 'rgba(248, 113, 113, 1)', // Red
                        borderWidth: 2,
                        yAxisID: 'y_EMF',
                        pointRadius: 0,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'none' },
                scales: {
                    x: { display: false },
                    y_B: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { display: false },
                        title: { display: true, text: 'µT', color: '#3b82f6', font: {size: 10} },
                        ticks: { color: '#3b82f6', font: {size: 10} }
                    },
                    y_EMF: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        title: { display: true, text: 'mV', color: '#f87171', font: {size: 10} },
                        ticks: { color: '#f87171', font: {size: 10} }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#94a3b8', font: {size: 10} } }
                }
            }
        });

        // --- DOM Elements ---
        const btnStart = document.getElementById('btn-start');
        const elValB = document.getElementById('val-b-field');
        const elValEmf = document.getElementById('val-emf');
        const elStatus = document.getElementById('status-msg');
        
        // Settings Inputs
        const sliderTurns = document.getElementById('slider-turns');
        const sliderRadius = document.getElementById('slider-radius');
        const lblTurns = document.getElementById('lbl-turns');
        const lblRadius = document.getElementById('lbl-radius');

        // --- Event Listeners ---
        sliderTurns.addEventListener('input', (e) => {
            coilTurns = parseInt(e.target.value);
            lblTurns.textContent = coilTurns;
        });

        sliderRadius.addEventListener('input', (e) => {
            coilRadiusCm = parseFloat(e.target.value);
            lblRadius.textContent = coilRadiusCm.toFixed(1);
            coilAreaM2 = Math.PI * Math.pow(coilRadiusCm / 100, 2);
        });

        btnStart.addEventListener('click', () => {
            if (!isRunning) {
                initSensor();
            } else {
                stopSensor();
            }
        });

        // --- Logic ---

        function stopSensor() {
            if (magnetometer) {
                magnetometer.stop();
            }
            isRunning = false;
            btnStart.textContent = "Start Sensor";
            btnStart.classList.replace('bg-red-600', 'bg-cyan-600');
            btnStart.classList.replace('hover:bg-red-500', 'hover:bg-cyan-500');
            elStatus.textContent = "Sensor stopped.";
        }

        async function initSensor() {
            // Check API Support
            if (!("Magnetometer" in window)) {
                elStatus.innerHTML = "<span class='text-red-400'>Error: Magnetometer API not supported by this browser. Try Chrome on Android.</span>";
                return;
            }

            // Check Permissions
            try {
                const result = await navigator.permissions.query({ name: "magnetometer" });
                if (result.state === "denied") {
                    elStatus.innerHTML = "<span class='text-red-400'>Permission denied. Enable sensors in browser settings.</span>";
                    return;
                }
            } catch (error) {
                console.log("Permission query skipped or failed", error);
            }

            try {
                // Initialize Sensor
                // frequency: 60Hz matches typical screen refresh rates for smooth graphs
                magnetometer = new Magnetometer({ frequency: 60 });
                
                magnetometer.addEventListener("reading", () => {
                    processReading(magnetometer.x, magnetometer.y, magnetometer.z, magnetometer.timestamp);
                });

                magnetometer.addEventListener("error", (event) => {
                    if (event.error.name === "NotReadableError") {
                        elStatus.textContent = "Sensor is not available.";
                    } else {
                        elStatus.textContent = `Error: ${event.error.name}`;
                    }
                    stopSensor();
                });

                magnetometer.start();
                isRunning = true;
                
                // Update Button UI
                btnStart.textContent = "Stop Sensor";
                btnStart.classList.replace('bg-cyan-600', 'bg-red-600');
                btnStart.classList.replace('hover:bg-cyan-500', 'hover:bg-red-500');
                elStatus.textContent = "Sensor active. Wave magnet to induce EMF.";
                
                // Initialize timing
                lastTime = performance.now();

            } catch (error) {
                elStatus.textContent = "Failed to start sensor: " + error.message;
            }
        }

        function processReading(x, y, z, timestamp) {
            if (!timestamp) timestamp = performance.now();

            // We use the Z-axis (perpendicular to screen) for the "Loop" simulation
            // This is like laying the coil flat on the screen.
            let rawB = z; 

            // Initialize on first run
            if (lastB === 0) {
                lastB = rawB;
                smoothedB = rawB;
                lastTime = timestamp;
                return;
            }

            // 1. Low Pass Filter (Smooth the noise)
            // Sensors are jittery; differentiation explodes noise. We must smooth first.
            smoothedB = smoothedB + ALPHA * (rawB - smoothedB);

            // 2. Calculate dt (Time delta in Seconds)
            // Timestamp is typically ms
            let dt = (timestamp - lastTime) / 1000;
            
            // Avoid division by zero or massive jumps
            if (dt <= 0 || dt > 1.0) {
                lastTime = timestamp;
                return; 
            }

            // 3. Calculate dB (Change in Field in Tesla)
            // Sensor gives µT, convert to T for physics (multiply by 1e-6)
            let deltaB_Tesla = (smoothedB - lastB) * 1e-6; 

            // 4. Faraday's Law: EMF = -N * A * (dB/dt)
            // Result is in Volts
            let emfVolts = -1 * coilTurns * coilAreaM2 * (deltaB_Tesla / dt);
            
            // Convert to mV for display
            let emfMillivolts = emfVolts * 1000;

            // 5. Update UI
            elValB.textContent = smoothedB.toFixed(1);
            elValEmf.textContent = emfMillivolts.toFixed(2);

            updateChart(smoothedB, emfMillivolts);

            // 6. Store State
            lastB = smoothedB;
            lastTime = timestamp;
        }

        function updateChart(bVal, emfVal) {
            const dataB = chart.data.datasets[0].data;
            const dataEmf = chart.data.datasets[1].data;

            // Shift Array
            dataB.shift();
            dataB.push(bVal);
            
            dataEmf.shift();
            dataEmf.push(emfVal);

            chart.update();
        }

        // Mock Data for Preview (Runs if no sensor found, for debugging/demo)
        // This allows the user to see the UI even on desktop
        if (!("Magnetometer" in window)) {
            setTimeout(() => {
                if(!isRunning) elStatus.innerHTML = "<span class='text-yellow-500'>Demo Mode (No Sensor Detected)</span>";
                setInterval(() => {
                    if(isRunning) return; // Don't run mock if real sensor is on
                    let time = performance.now() / 1000;
                    let fakeB = 50 * Math.sin(time * 5); // 50uT sine wave
                    // Derivative of sin is cos
                    // EMF prop to cos
                    let fakedt = 0.016;
                    let fakeDiff = (fakeB - (50 * Math.sin((time - fakedt) * 5))) * 1e-6;
                    let fakeEmf = -1 * coilTurns * coilAreaM2 * (fakeDiff / fakedt) * 1000;
                    
                    elValB.textContent = fakeB.toFixed(1);
                    elValEmf.textContent = fakeEmf.toFixed(2);
                    updateChart(fakeB, fakeEmf);
                }, 1000 / 60);
            }, 1000);
        }
    </script>
</body>
</html>
